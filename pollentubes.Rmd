---
title: '*Schiedea kaalae* and *S. hookeri* pollen tube growth'
author: "John Powers"
date: '2022-05-11'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: console
---

# Purpose
Test for post-pollination, pre-zygotic reproductive barriers between two plant species, *Schiedea kaalae* and *S. hookeri* by measuring pollen tube growth from parental and hybrid crosses at two time points.

Response variables:

* Counts - assume a Poisson distribution for count data 
    - **grains** - the number of pollen grains on the stigma
    - **mid** - the number of pollen tubes counted at the middle of the style
    - **bottom** - the number of pollen tubes counted at the bottom of the style

* Proportions - assume a binomial distribution for binomial data
    - **ratio** - the ratio of pollen tubes at the **bottom** / **middle** of the style, capped at 1 because having more pollen grains at the bottom than the middle of the style is impossible (must result from counting error). For the binomial model, the input is the number of sucesses (pollen tubes at **bottom**) and failures (min(**bottom**/**mid**) - **bottom**).


Fixed effects:

* **cross** - the maternal plant x the paternal plant
* **hr** - the time elapsed since pollination: 4 hr or 24 hr

Random effects:

* **momid** - maternal genotype, specified by its cross and plant number
* **dadid** - paternal genotype, specified by its cross and plant number

# Explore data

```{r setup, message=FALSE}
library(knitr)
knitr::opts_chunk$set(comment="  ", warning=F, cache=T)
options(knitr.kable.NA = '')

library(tidyverse)

library(ggsignif) 
library(ggforce)

library(broom)
library(multcomp) #Multiple comparisons package - for general linear hypothesis testing
library(emmeans) #Estimated marginal means aka least square means. use old version for glmmADMB: install_version("emmeans", version = "1.3.1", repos = "http://cran.us.r-project.org")
library(glmmTMB) #generalized linear mixed models with Template Model Builder

#overwrite function to make emmeans and multcomp play nice
modelparm.glmmTMB <- function (model, coef. = function(x) fixef(x)[[component]],
                               vcov. = function(x) vcov(x)[[component]],
                               df = NULL, component="cond", ...) {
    multcomp:::modelparm.default(model, coef. = coef., vcov. = vcov.,
                        df = df, ...)
}

signif.num <- function(x) {
    symnum(x, corr = FALSE, na = FALSE, legend = FALSE,
           cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), 
           symbols = c("***", "**", "*", ".", " "))
}
```


## Read data

```{r read, message = FALSE}
setwd("~/MyDocs/MEGA/UCI/Schiedea/Analysis/HybridSeeds")
tubes <- read_csv("pollentubes_kaahoo_extra.csv") %>% mutate(across(ends_with("sp"), as.factor)) %>% 
  pivot_longer(starts_with(c("mid","bottom")), names_to=c("location","stigma"), names_sep="_", values_to="n_tubes") %>% 
  pivot_wider(names_from="location", values_from="n_tubes") %>% 
  drop_na(mid, bottom) %>% #one entry has mid but no bottom count
  mutate(vial=as.character(vial),
         momcross = toupper(str_sub(momsp,1,1)),
         dadcross = toupper(str_sub(dadsp,1,1)),
         observer="SGW") %>% 
  bind_rows(read_csv("pollentubes_kaahoo.csv") %>% #edited from pollentubes.csv
              separate(cross, into=c("momcross","dadcross"), sep="x") %>% 
              mutate(observer="SZ")) %>% 
  mutate(
    hr = factor(paste0(hr,"hr"), levels=c("4hr","24hr")),
    ratioraw = bottom/mid,
    adjmid = ifelse(bottom > mid, bottom, mid),
    ratio = bottom/adjmid,
    justmid = mid - bottom,
    momid = paste(momcross, momid),
    dadid = paste(dadcross, dadid),
    cross = factor(paste0(momcross,"x",dadcross), levels=c("KxK","KxH","HxH","HxK")),
    crosshr = factor(paste0(cross, hr), levels = paste(rep(levels(cross),each=2), levels(hr), sep=""))) %>% 
  mutate_if(is.character, as.factor)
str(tubes)

tube.contrasts <- c("HxH4hr  - HxH24hr == 0",
                              "HxK4hr  - HxK24hr == 0",
                              "HxH4hr  - HxK4hr  == 0",
                              "HxH24hr - HxK24hr == 0",
                              "KxH4hr  - KxH24hr == 0",
                              "KxK4hr  - KxK24hr == 0",
                              "KxH4hr  - KxK4hr  == 0",
                              "KxH24hr - KxK24hr == 0",
                              "HxH4hr  - KxK4hr  == 0",
                              "HxH24hr - KxK24hr == 0",
                              "HxH4hr+HxK4hr   - KxK4hr-KxH4hr   == 0",
                              "HxH24hr+HxK24hr - KxK24hr-KxH24hr == 0")
```

## Inventory of crosses

```{r inventory}
with(tubes, table(cross, hr, observer))
with(tubes, table(cross, momid, observer))
with(tubes, table(dadid, momid))

tubes %>% pivot_longer(c(momid, dadid), values_to = "genotype", values_ptypes = character()) %>% 
  count(genotype, name) %>% pivot_wider(values_from="n") %>% arrange(genotype) %>% 
  kable(caption="Number of stigmas split by paternal or maternal genotype")
```

## Plot raw data

### Pollen tubes
```{r rawplots, warning = FALSE}
mytheme <- theme(legend.text=element_text(size=rel(1)), legend.position="right", axis.text = element_text(colour="black", size=rel(1)), text=element_text(size=14), axis.ticks.x = element_blank())
timecolors <- scale_color_brewer(palette=3, type="qual", labels=c("4 hr","24 hr"))
crosslabs <- gsub("x", " x ",levels(tubes$cross), fixed=T)

(tubeplot.mid <- 
    ggplot(tubes, aes(x=cross, y=mid, color=hr)) + 
    labs(x="", y="Pollen tubes at middle of style", color="Time") +
    geom_violin(position=position_dodge(), draw_quantiles=c(0.25,0.5,0.75), size=0.5, bw=1) +
    geom_sina(bw=0.1) + 
    scale_x_discrete(labels=crosslabs) + 
    theme_classic() + mytheme + timecolors)

(tubeplot.bottom <- 
    ggplot(tubes, aes(x=cross, y=bottom, color=hr)) + 
    labs(x="", y="Pollen tubes at bottom of style", color="Time") +
    geom_violin(position=position_dodge(), draw_quantiles=c(0.25,0.5,0.75), size=0.5, bw=1) +
    geom_sina(bw=0.1)+
    scale_x_discrete(labels=crosslabs) + 
    theme_classic() + mytheme + timecolors)

(tubeplot.ratio <- 
    ggplot(tubes, aes(x=cross, y=ratio, color=hr)) +
    labs(x="", y="Ratio of pollen tubes at bottom : middle of style",color="Time") +
    geom_violin(position=position_dodge(), draw_quantiles=c(0.25,0.5,0.75), size=0.5, bw=0.1) + 
    geom_sina(bw=0.1)+
    scale_y_continuous(expand = expansion(add=c(0,0.01)), breaks = scales::pretty_breaks(n = 5)) +
  scale_x_discrete(labels=crosslabs) + 
  theme_classic() + mytheme + timecolors)

(tubeplot.justmid <- 
    ggplot(tubes, aes(x=cross, y=justmid, color=hr)) +
    labs(x="", y="Difference of pollen tubes at middle and bottom of style",color="Time") +
    geom_violin(position=position_dodge(), draw_quantiles=c(0.25,0.5,0.75), size=0.5, bw=1) + 
    geom_sina(bw=1) + 
      scale_x_discrete(labels=crosslabs) + 
  theme_classic() + mytheme + timecolors)

(tubeplot.mid.bottom <- 
    ggplot(tubes, aes(x=bottom, y=mid)) + 
    labs(x="Pollen tubes at bottom of style", y="Pollen tubes at middle of style", color="Cross", linetype="Time") +
    geom_abline(slope=1, size=1) +
    geom_point(color="grey") + 
    stat_ellipse(aes(linetype=hr, color=cross), size=1) + 
    coord_fixed(xlim=c(0,NA),ylim=c(0,NA))+
    scale_color_discrete(labels=crosslabs)+ scale_linetype_discrete(labels=c("4 hr","24 hr"))+
    theme_classic()+theme(legend.text=element_text(size=rel(1)), legend.position="right", axis.text = element_text(colour="black", size=rel(1)), text=element_text(size=14)))

```

# Models

## Pollen tubes at middle of style

```{r model.mid, warning=FALSE}
#Quasi-Poisson (NB1), log link, zero inflation
mod <- glmmTMB(mid~cross*hr + (1|momid) + (1|dadid), data=tubes, family="poisson")
summary(mod)
```

```{r contrasts.mid}
crosshr.x <- data.frame(crosshr=levels(tubes$crosshr), x=rep(1:4, each=2)+rep(c(-0.25, 0.25), 4))
cont <- glmmTMB(mid~crosshr + (1|momid) + (1|dadid), data=tubes, family="poisson") %>%
  glht(linfct = mcp(crosshr=tube.contrasts)) %>%
  summary(test=adjusted(type="fdr")) %>% tidy %>% 
  separate(contrast, c("lvl1", "lvl2"), sep = " - ", extra="merge") %>%
  mutate(signif = adj.p.value < 0.05, 
         stars = signif.num(adj.p.value), 
         height =  c(rep(c(1,1,2,3),2),4,5,NA,NA), 
         x1 = crosshr.x[match(lvl1, crosshr.x$crosshr),"x"], 
         x2 = crosshr.x[match(lvl2, crosshr.x$crosshr),"x"])
kable(cont[,-c(1,4, 7, 9,11:13)], digits=c(0,0,3,3,3,8), caption="Contrasts")
```

```{r emmeans.mid}
timefills <- scale_fill_brewer(palette=3, type="qual", labels=c("24 hr","4 hr"), direction=-1)

cld.mod <- ref_grid(mod) %>% 
  emmeans(~ cross*hr) %>% 
  summary %>%
  mutate(response = exp(emmean), uSE = exp(emmean+SE), lSE = exp(emmean-SE))
kable(cld.mod[, -c(3:7)], digits=1, caption = "Estimated marginal means")

(mid.emplot <- ggplot(cld.mod, aes(y=response, x=cross, fill=hr)) +
  geom_signif(y_position=cont$height+max(cld.mod$uSE), xmin = cont$x1, xmax = cont$x2, annotations=cont$stars, vjust=0.5) +
  geom_col(position=position_dodge2()) +
  geom_linerange(aes(ymin=lSE, ymax=uSE), position=position_dodge2(0.9)) +
  labs(x="", y="Pollen tubes at middle of style",fill="Time") +
  scale_y_continuous(limits=c(0,NA), expand = expansion(add=c(0,0.5)), breaks = scales::pretty_breaks(n = 8)) +
  scale_x_discrete(labels=crosslabs) + 
  theme_classic() + mytheme + timefills)
```


## Pollen tubes at bottom of style
```{r model.bottom, warning=FALSE}
#Quasi-Poisson (NB1), log link, zero inflation
mod <- glmmTMB(bottom~cross*hr + (1|momid) + (1|dadid), data=tubes, family="poisson")
summary(mod)
```

```{r contrasts.bottom}
cont <- glmmTMB(bottom~crosshr + (1|momid) + (1|dadid), data=tubes, family="poisson") %>%
  glht(linfct = mcp(crosshr=tube.contrasts)) %>%
  summary(test=adjusted(type="fdr")) %>% tidy %>% 
  separate(contrast, c("lvl1", "lvl2"), sep = " - ", extra="merge") %>%
  mutate(signif = adj.p.value < 0.05, 
         stars = signif.num(adj.p.value), 
         height =  c(rep(c(1,1,2,3),2),4,5,NA,NA), 
         x1 = crosshr.x[match(lvl1, crosshr.x$crosshr),"x"], 
         x2 = crosshr.x[match(lvl2, crosshr.x$crosshr),"x"])
kable(cont[,-c(1,4, 7, 9,11:13)], digits=c(0,0,3,3,3,8), caption="Contrasts")
```


```{r emmeans.bottom}
cld.mod <- ref_grid(mod) %>% 
  emmeans(~ cross*hr) %>% 
  summary %>%
  mutate(response = exp(emmean), uSE = exp(emmean+SE), lSE = exp(emmean-SE))
kable(cld.mod[, -c(3:7)], digits=1, caption = "Estimated marginal means")

(bottom.emplot <- ggplot(cld.mod, aes(y=response, x=cross, fill=hr)) +
  geom_signif(y_position=cont$height+max(cld.mod$uSE), xmin = cont$x1, xmax = cont$x2, annotations=cont$stars, vjust=0.5) +
  geom_col(position=position_dodge2()) +
  geom_linerange(aes(ymin=lSE, ymax=uSE), position=position_dodge2(0.9)) +
  labs(x="", y="Pollen tubes at bottom of style",fill="Time") +
  scale_y_continuous(limits=c(0,NA), expand = expansion(add=c(0,0.5)), breaks = scales::pretty_breaks(n = 8)) +
  scale_x_discrete(labels=crosslabs) + 
  theme_classic() + mytheme + timefills)
```

## Pollen tubes at bottom : middle of style
```{r model.ratio, warning=FALSE}
#Beta binomial - for overdispersed binomial data. Input is the number of successes and failures.
mod <- glmmTMB(cbind(bottom, adjmid-bottom)~cross*hr + (1|momid) + (1|dadid), data=tubes, family="binomial")
summary(mod)
```

```{r contrasts.ratio}
cont <- glmmTMB(cbind(bottom, adjmid-bottom)~crosshr + (1|momid) + (1|dadid), data=tubes, family="binomial") %>%
  glht(linfct = mcp(crosshr=tube.contrasts)) %>%
  summary(test=adjusted(type="fdr")) %>% tidy %>% 
    separate(contrast, c("lvl1", "lvl2"), sep = " - ", extra="merge") %>%
  mutate(signif = adj.p.value < 0.05, 
         stars = signif.num(adj.p.value), 
         height =  c(rep(c(1,1,2,3),2),4,5,NA,NA), 
         x1 = crosshr.x[match(lvl1, crosshr.x$crosshr),"x"], 
         x2 = crosshr.x[match(lvl2, crosshr.x$crosshr),"x"])
kable(cont[,-c(1,4, 7, 9,11:13)], digits=c(0,0,3,3,3,8), caption="Contrasts")
```


```{r emmeans.ratio}
cld.mod <- ref_grid(mod) %>% 
  emmeans(~ cross*hr) %>% 
  summary %>%
  mutate(response = plogis(emmean), uSE = plogis(emmean+SE), lSE = plogis(emmean-SE))
kable(cld.mod[, -c(3:7)], digits=2, caption = "Estimated marginal means")

(ratio.emplot <- ggplot(cld.mod, aes(y=response, x=cross, fill=hr)) +
  geom_signif(y_position=cont$height/15+1, xmin = cont$x1, xmax = cont$x2, annotations=cont$stars, vjust=0.5) +
  geom_col(position=position_dodge2()) +
  geom_linerange(aes(ymin=lSE, ymax=uSE), position=position_dodge2(0.9)) +
  labs(x="", y="Ratio of pollen tubes at bottom : middle of style",fill="Time") +
  scale_y_continuous(expand = expansion(add=c(0,0.05)), breaks = seq(0,1, by=0.2)) +
  scale_x_discrete(labels=crosslabs) + 
  theme_classic() + mytheme + timefills)
```

# Package citations

```{r citations}
citation("glmmTMB")
citation("emmeans")
citation("multcomp")
```

