---
title: "Schiedea hookeri/kaalae RIMs"
author: "[John Powers](http://sites.uci.edu/powers/)"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
  .main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>


```{r setup, message = FALSE}
library(tidyverse)
library(RColorBrewer)

library(glmmTMB)
library(car)
library(broom)
library(emmeans)

library(knitr)
knitr::opts_chunk$set(comment="", cache=T, warning = F, message = F, fig.path = "figures/", dev = "svglite", fig.width=5, fig.height=4)
options(digits=4, knitr.kable.NA = "") # for kables

load("data/rims_data.rda")

sxc.labels <- set_names(c("K intrapop", "K interpop", "K x H", "H x K", "H interpop", "H intrapop"), sxc.levels)
F1.col <- set_names(c(brewer.pal(3,"Greens")[2:3],brewer.pal(9,"Oranges")[5], brewer.pal(9,"Set1")[7], brewer.pal(3,"Purples")[3:2]), sxc.levels)
```

# Sample sizes

```{r sampsize}
F1 <- set_names(datanames[1:6]); F1[[6]] <- "inflobiomass.sum"
F2 <- set_names(datanames[7:10])

map_dfr(F1, ~ tally(get(.)), .id="dataset") %>% 
  pivot_wider(names_from=dataset, values_from=n) %>% kable(caption="F1 datasets totals")

map_dfr(F1, ~ tally(group_by(get(.), crosstype, momsp, dadsp)), .id="dataset") %>% 
  pivot_wider(names_from=dataset, values_from=n) %>% kable(caption="F1 datasets by crosstype and species")

map_dfr(F1, ~ tally(group_by(get(.), crosstype, momsp, dadsp, mompop, dadpop)), .id="dataset") %>% 
  pivot_wider(names_from=dataset, values_from=n) %>% kable(caption="F1 datasets by crosstype and population")

map_dfr(F2, ~ tally(get(.)), .id="dataset") %>% 
  pivot_wider(names_from=dataset, values_from=n) %>% kable(caption="F2 datasets totals")

map_dfr(F2, ~ tally(group_by(get(.), generation, momdadcross)), .id="dataset") %>% 
  pivot_wider(names_from=dataset, values_from=n) %>% kable(caption="F2 datasets by cross")
```

# F1 Generation

## Models

```{r models}
F1.mod <- list(
  firstflower =          glmmTMB(firstflower ~          sxc +           (1|mompid) + (1|dadpid), data=survflr),
  firstinflo.biomass.g = glmmTMB(firstinflo.biomass.g ~ sxc + collect + (1|mompid) + (1|dadpid), data=survflr),
  inflo.biomass.g =      glmmTMB(inflo.biomass.g  ~     sxc + collect + (1|mompid) + (1|dadpid), data=inflobiomass.sum),
  veg.biomass.g =        glmmTMB(veg.biomass.g ~        sxc + collect + (1|mompid) + (1|dadpid), data=vegbiomass),
  total.per.anther =     glmmTMB(total.per.anther ~     sxc +           (1|mompid) + (1|dadpid), data=pollen),
  viable.seeds =         glmmTMB(viable.seeds ~         sxc +           (1|mompid) + (1|dadpop), data=filter(seeds, viable.seeds>0),
                                 family="truncated_nbinom1"),
  prop.germ =            glmmTMB(prop.germ      ~ sxc + (1|mompid) + (1|dadpid), family="binomial", data=germination, weights = planted),
  alive =                glmmTMB(alive          ~ sxc + (1|mompid) + (1|dadpid), family="binomial", data=survflr),
  flowered =             glmmTMB(flowered       ~ sxc + (1|mompid) + (1|dadpid), family="binomial", data=filter(survflr, alive)),
  prop.viable =          glmmTMB(prop.viable    ~ sxc + (1|mompid) + (1|dadpid), family="binomial", data=pollen, weights = total),
  capsule.formed =       glmmTMB(capsule.formed ~ sxc + (1|mompid) + (1|dadpop), family="binomial", data=seeds))
#TODO try to find dadpid for seeds
```

## Inference 

```{r inference}
F1.test <- map_dfr(F1.mod, ~car::Anova(.) %>% tidy(), .id="trait")
F1.emm <-  map_dfr(F1.mod, ~emmeans(., ~sxc) %>% summary(type="response") %>%  #average over collect date
                             tidy %>% rename(estimate=any_of(c("response","prob"))), .id="trait") 
```

## Plots

```{r f1plot}
plot_F1 <- function(emm, data, yvar, ylab, type="continuous") {
  data <- get(data)
  if(type=="continuous") {
    p <- ggplot(data, aes_string(y=yvar, x="sxc", fill="sxc")) +
      geom_violin(draw_quantiles = (1:3)/4) + 
      geom_pointrange(data=filter(emm, trait==yvar), aes(y=estimate, ymax=conf.high, ymin=conf.low)) + 
      scale_fill_manual(values=F1.col) + guides(fill="none") +
      scale_y_continuous(name = ylab, expand = expansion(mult=c(0, 0.05)), limits=c(0,NA))
  } else if(type=="binary") {
    p <- data %>% drop_na(all_of(yvar)) %>% 
      group_by(sxc, mompop, dadpop) %>% summarize(across(all_of(yvar), ~sum(.)/n()), n=n(), .groups="drop") %>% 
      ggplot(aes_string(y=yvar, x="sxc", color="sxc")) +
      geom_point(size=4)+
      geom_pointrange(data=filter(emm, trait==yvar) %>% 
                        mutate(conf.low  = ifelse(conf.high-conf.low>0.9,NA,conf.low), 
                               conf.high = ifelse(conf.high-conf.low>0.9,NA,conf.high)), 
                      aes(y=estimate, ymax=conf.high, ymin=conf.low), color="black") + 
      scale_color_manual(values=F1.col) + guides(color="none") +
      scale_y_continuous(ylab, limits=c(0,1), labels=~scales::percent(.,accuracy=1))
  }
  p <- p + scale_x_discrete("Cross", labels = sxc.labels) + 
    theme_minimal() + theme(panel.grid.major.x = element_blank())
  print(p)
}

traits %>% filter(generation=="F1", yvar!="flower.number") %>% select(data, yvar, ylab, type) %>% 
  pwalk(plot_F1, emm=F1.emm)
```
